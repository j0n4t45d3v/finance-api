<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings
    xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/orm_2_2.xsd"
    version="2.2">
  <package>br.com.managementfinanceapi</package>

  <named-query name="Balance.findAllBalancesAfterMonthYear">
    <query>select b from Balance b where b.month > :month and b.year > :year and b.userDomain.id = :userId</query>
  </named-query>

  <named-query name="Category.findTotalByCategory">
    <query>
      select
      new br.com.managementfinanceapi.application.core.domain.category.dto.TotalByCategoryView(
        c.name,
        c.creditLimit,
        sum(t.amount) as value
      )
      from Category c
      inner join Transaction t
        ON t.category.id = c.id AND
           t.userDomain.id = c.userDomain.id
      where month(t.date) = :month 
        and year(t.date) = :year 
        and c.userDomain.id = :userId
      group by c.name, c.creditLimit
      order by value, c.name
    </query>
  </named-query>

</entity-mappings>